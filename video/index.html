<!DOCTYPE html>
<html lang="cs">
<head>
	<title>Klasifikace logopedických cviků</title>
	<meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<script>
const subjects = [1, 2, 3]
const videos = {
	"jazyk_doleva_a_doprava.mp4": ["Střídání pohybu jazyka vpravo a vlevo", "tongue_left tongue_right head neck jaw tongue_shape lips_move", "Špičku jazyka střídavě vysouváme vpravo a vlevo směrem k uším. Ústa jsou otevřená, nepohybujeme dolní čelistí do stran"],
	"jazyk_nahoru_a_dolu.mp4": ["Střídání pohybu jazyka nahoru a dolů", "tongue_up tongue_down symm head neck jaw tongue_shape lips_move", "Špičku jazyka střídavě vysouváme nahoru a dolů. Jazyk držíme po krátkou dobu v napětí v obou pozicích. Ústa jsou otevřená, nepomáháme si dolní čelistí."],
	"krivy_usmev.mp4": ["Zvedání levého a pravého koutku", "corner corner_still two_symm head neck", "Zvedáme střídavě levý a pravý koutek nahoru do strany. Nepohybujeme čelistí."],
	"nafukovani_obou_tvari.mp4": ["Nafukování tváří", "brightness symm head lips_open", "Nafoukneme obě tváře a zadržíme v nich vzduch. Rty jsou pevně sevřené, vzduch nesmí unikat nosem ani ústy. Vzduch poté vydechneme."],
	"nafukovani_tvari.mp4": ["Střídavé nafukování tváří", "brightness head lips_open", "Nafoukneme obě tváře a zadržíme v nich vzduch. Rty jsou pevně sevřené. Vzduch poté pomalu přeléváme z jedné tváře do druhé. Vzduch nesmí unikat nosem ani ústy. Vzduch poté vydechneme."],
	"obraceny_usmev.mp4": ["Koutky dolů", "-corner -open symm head neck", "Stáhneme pravý i levý koutek současně směrem dolů, snažíme se usmát „obráceně“."],
	"ocko.mp4": ["Našpulení rtů se zuby (óčko ze rtů)", "square open teeth symm head -teeth tongue_still", "Sevřeme a našpulíme rty směrem dopředu, rty jsou kulatě otevřené. Lehce skousnuté zuby jsou viditelné."],
	"pusinka.mp4": ["Našpulení rtů (pusinka)", "square -open symm head lips_open", "Sevřeme a našpulíme rty směrem dopředu."],
	"usmev.mp4": ["Úsměv", "corner -open width symm head", "Zavřeme ústa a roztáhneme rty do úsměvu. Snažíme se rozšířit úsměv co nejvíce do stran."],
	"usmev_zuby_od_sebe.mp4": ["Úsměv se zuby od sebe", "corner open width teeth symm head", "Doširoka se usmějeme. Otevřeme ústa a ukážeme horní i spodní zuby. Zuby nejsou skousnuté, snažíme se rozšířit úsměv co nejvíce do stran a uvolníme krk."],
	"usmev_zuby_u_sebe.mp4": ["Úsměv se zuby u sebe", "corner open width -teeth symm head", "Usmějeme se tak, aby šly vidět horní i spodní zuby. Snažíme se rozšířit úsměv co nejvíce do stran, zuby držíme u sebe."],
	"epilogue": ["Závěr", "", "Kliknutím na tlačítko zkontrolujete, že je vše vyplněné. Poté se vaše záznamy uloží jako soubor „logopedie.json“. Tento soubor nám prosím pošlete e-mailem."],
}
const columns = [0, 1, 2]
const translation = {
	"okay": "Uznatelné",
	"corner": "Koutek úst nejde dost vysoko",
	"-corner": "Koutek úst nejde dost dolů",
	"corner_still": "Zapojuje se druhý koutek",
	"open": "Ústa jsou málo otevřená",
	"-open": "Ústa jsou otevřená",
	"width": "Úsměv je málo široký",
	"teeth": "Zuby nejsou od sebe",
	"square": "Rty netvoří kruh",
	"tongue_up": "Jazyk jde málo nahoru",
	"tongue_down": "Jazyk jde málo dolů",
	"tongue_left": "Jazyk jde málo doleva (z pohledu kamery)",
	"tongue_right": "Jazyk jde málo doprava (z pohledu kamery)",
	"brightness": "Tvář není dostatečně vyboulená",
	"symm": "Není symetrické",
	"two_symm": "Není symetrické na jednu a druhou stranu",
	"head": "Hýbe se hlava",
	"neck": "Zapojují se krční svaly",
	"lips_open": "Rty nejsou v kontaktu",
	"jaw": "Zapojuje se čelist",
	"tongue_shape": "Jazyk není v protažení",
	"lips_move": "Zapojují se rty",
	"-teeth": "Zuby nejsou v lehkém kontaktu",
	"tongue_still": "Není správná klidová poloha jazyka",
}

const classification = {}
const ui = {}
const keyMap = new Map()

qel = (query) => document.querySelector(query)
gel = (id) => document.getElementById(id)

// create element
function cel(name, parameters={}) {
	var element = document.createElement(name)
	for (const param in parameters) {
		element[param] = parameters[param]
	}
	return element
}

// shuffle an array in-place and also return it
function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]]
    }
    return array
}

function splitAttributes(attributes) {
	return ("okay " + attributes).split(" ")
}

// callback: image was changed, update view
function changeImage() {
	const filename = ui.select.value;
	ui.progressbar.style.width = `${Math.round(100 * (ui.select.selectedIndex + 1) / ui.select.options.length)}%`
	if (ui.video.dataset.src === filename) {
		return
	} else if (filename === "epilogue") {
		const [title, _, description] = videos[filename]
		ui.title.textContent = title
		ui.description.textContent = description
		ui.content.classList.add("hidden")
		ui.epilogue.classList.remove("hidden")
		ui.video.dataset.src = ""
		return
	}
	ui.content.classList.remove("hidden")
	ui.epilogue.classList.add("hidden")
	ui.video.src = filename
	ui.video.dataset.src = filename
	const videoname = filename.substring(2)
	const [title, attributes, description] = videos[videoname]
	ui.title.textContent = title
	ui.description.textContent = description
	if (classification[filename] === undefined) {
		classification[filename] = {}
	}
	ui.attributes.innerHTML = ""
	const current = classification[filename]
	for (const attr of splitAttributes(attributes)) {
		const tr = cel("tr")
		for (const i of columns) {
			const td = cel("td")
			const name = `${attr}_${i}`
			td.append(cel("input", {type: "checkbox", onchange: inputChange, name, checked: current[name]}))
			tr.append(td)
		}
		tr.append(cel("td", {textContent: translation[attr], onclick: checkTr, classList: ["clickable"]}))
		ui.attributes.appendChild(tr)
		ui.comment.value = current[ui.comment.name] || ""
	}
}

// callback: download was requested
function downloadClick(ev) {
	if (isComplete()) {
		const data = JSON.stringify(classification)
		ui.download.href = `data:application/json,${data}`
	} else {
		window.alert("Bohužel ještě není formulář zcela vyplněný. V každém sloupci by mělo být aspoň jedno políčko zaškrtnuté.")
		changeImage()
	}
}

// callback: any checkbox button was clicked
function inputChange(ev) {
	const filename = ui.select.value
	const current = classification[filename]
	for (input of ui.attributes.querySelectorAll("input")) {
		current[input.name] = input.checked
	}
	current[ui.comment.name] = ui.comment.value
}

// callback: mark all boxes in a <tr> as checked
function checkTr(ev) {
	const tr = ev.target.parentElement
	const inputs = Array.from(tr.querySelectorAll("input"))
	const value = !inputs.every(it => it.checked)
	for (const input of inputs) {
		input.checked = value
	}
	inputChange()
}

function keyDown(ev) {
	if (keyMap.has(ev.key)) {
		ev.preventDefault()
		keyMap.get(ev.key)()
	}
}

function prevClick(ev) {
	ui.select.selectedIndex = Math.max(0, ui.select.selectedIndex - 1)
	changeImage()
}

function nextClick(ev) {
	ui.select.selectedIndex = Math.min(ui.select.length - 1, ui.select.selectedIndex + 1)
	changeImage()
}

// check that each video has some user input in each column
function isComplete() {
	for (const option of ui.select.querySelectorAll("option")) {
		const filename = option.value
		if (filename === "epilogue") {
			continue
		}
		const current = classification[filename] || {}
		const videoname = filename.substring(2)
		const everyColumnChecked = columns
			.every(i => splitAttributes(videos[videoname][1])
				.some(key => current[`${key}_${i}`]))
		const hasComment = (current["comment"] && current["comment"].trim() != "")
		if (!everyColumnChecked && !hasComment) {
			ui.select.value = filename
			return false
		}
	}
	return true
}

function setKeyMap() {
	const keys = [
		['ArrowLeft', prevClick],
		['ArrowRight', nextClick],
	]
	for (const [key, fn, ...args] of keys) {
		keyMap.set(key, fn.bind(null, ...args))
	}
}

window.onload = () => {
	ui.content = gel("content")
	ui.epilogue = gel("epilogue")
	ui.select = qel("select")
	ui.video = qel("video")
	ui.download = gel("download")
	ui.form = qel("form")
	ui.attributes = qel("tbody")
	ui.title = qel("h1")
	ui.description = qel("p")
	ui.comment = qel("textarea")
	ui.progressbar = qel(".progressbar")
	for (const videoname of shuffle(Object.keys(videos))) {
		if (videoname == "epilogue") {
			continue
		}
		for (const i of shuffle([...subjects])) {
			const filename = `${i}_${videoname}`
			ui.select.append(cel("option", {textContent: `${videos[videoname][0]} - ${i}`, value: filename}))
		}
	}
	ui.select.append(cel("option", {textContent: videos["epilogue"][0], value: "epilogue"}))

	ui.select.oninput = changeImage
	ui.download.onclick = downloadClick
	setKeyMap()
	document.onkeydown = keyDown
	gel("prev").onclick = prevClick
	gel("next").onclick = nextClick
	changeImage()
	ui.video.focus()
}

</script>
<style>
* {
	font-family: Calibri, Segoe, sans-serif
}
body {
	display: flex;
	flex-flow: column;
	align-items: center;
	max-width: 1200px;
	margin: auto;
}
body>* {
	margin: 0.5em 0;
}
.hflex {
	display: flex;
	flex-flow: row wrap;
	justify-content: center;
	width: 100%
}
.vflex {
	max-width: 100vw;
	display: flex;
	flex-flow: column;
	justify-content: space-between;
}
video {
	margin: 0 1em;
	max-width: 100vw;
}
table {
	border-collapse: collapse;
	width: 100%;
}
th:only-child {
	text-align: left;
}
tr:nth-child(1) td {
    border-bottom: 1px solid gray;
}
.clickable {
	cursor: pointer
}
.hidden {
	display: none
}
.progress-box {
	width: calc(100% - 2em);
	height: 1em;
	border: 1px solid gray;
}
.progressbar {
	width: attr(data-progress %);
	height: 100%;
	background-color: gray;
}
</style>
</head>
<body>
<h1>Jazyk doleva a doprava</h1>
<p>Špičku jazyku střídavě vysouváme vpravo a vlevo směrem k uším. Ústa jsou otevřená, nepohybujeme dolní čelistí do stran.</p>
<div class=hflex id=content>
	<video tabindex=0 controls></video>

	<div class=vflex>
		<button id="prev" class=top>〈 Předchozí video</button>
		<div>
		<table><thead>
			<tr><th colspan=4>Opakování cviku</th></tr>
			<tr><th>1.</th><th>2.</th><th>3.</th><th></th></tr>
		</thead><tbody></tbody></table>
		<label class=vflex>Slovní komentář:
		<textarea name="comment" cols=30 rows=3 oninput="inputChange(event)"></textarea>
		</label>
		</div>
		<button id="next" class=bottom>Další video 〉</button>
	</div>
</div>
<div class=hflex id=epilogue>
	<a id="download" download="logopedie.json">
		<button>Uložit všechny záznamy...</button>
	</a>
</div>
<select></select>
<div class=progress-box><div class=progressbar></div></div>
</body>
</html>
