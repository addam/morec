<!DOCTYPE html>
<html lang="cs">
<head>
	<title>Klasifikace logopedických cviků</title>
	<meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<script>
const images = ["jazyk_doleva_a_doprava.mp4", "jazyk_nahoru_a_dolu.mp4", "krivy_usmev.mp4", "nafukovani_obou_tvari.mp4", "nafukovani_tvari.mp4", "obraceny_usmev.mp4", "ocko.mp4", "pusinka.mp4", "usmev.mp4", "usmev_zuby_od_sebe.mp4", "usmev_zuby_u_sebe.mp4"].flatMap(name => [1, 2, 3].map(i => `${i}_${name}`))
const attributes = {
	"jazyk_doleva_a_doprava.mp4": "tongue_left tongue_right",
	"jazyk_nahoru_a_dolu.mp4": "tongue_up tongue_down",
	"krivy_usmev.mp4": "head symm",
	"nafukovani_obou_tvari.mp4": "head symm",
	"nafukovani_tvari.mp4": "head symm",
	"obraceny_usmev.mp4": "head symm",
	"ocko.mp4": "head symm closed",
	"pusinka.mp4": "head symm lips",
}
const translation = {
	"jazyk_doleva_a_doprava.mp4": "Jazyk doleva a doprava",
	"jazyk_nahoru_a_dolu.mp4": "Jazyk nahoru a dolů",
	"krivy_usmev.mp4": "Křivý úsměv",
	"nafukovani_obou_tvari.mp4": "Nafukování obou tváří",
	"nafukovani_tvari.mp4": "Nafukování tváří",
	"obraceny_usmev.mp4": "Koutky dolů",
	"ocko.mp4": "Óčko",
	"pusinka.mp4": "Pusinka",
	"corner": "Výška koutků",
	"open": "Otevřenost",
	"width": "Šířka",
	"teeth": "Zuby u/od sebe",
	"square": "Tvar O",
	"tongue_up": "Jazyk nahoře",
	"tongue_down": "Jazyk dole",
	"tongue_left": "Jazyk doleva",
	"tongue_right": "Jazyk doprava",
	"symm": "Symetrie",
	"head": "Není pohyb hlavou",
	"lips": "Rty jsou v kontaktu",
	"closed": "Zuby na sobě v lehkém kontaktu",
}

const classification = {}
const ui = {}
const keyMap = new Map()

qel = (query) => document.querySelector(query)
gel = (id) => document.getElementById(id)

// create element
function cel(name, parameters={}) {
	var element = document.createElement(name)
	for (const param in parameters) {
		element[param] = parameters[param]
	}
	return element
}

// create a checkbox element
function createCheckbox(name, checked) {
	const tr = cel("tr")
	for (const i of [0, 1, 2]) {
		const td = cel("td")
		td.append(cel("input", {type: "checkbox", onchange: inputChange, name: `${name}_${i}`, checked: checked[i]}))
		tr.append(td)
	}
	tr.append(cel("td", {textContent: translation[name]}))
	return tr
}

// callback: image was changed, update view
function changeImage() {
	const filename = ui.select.value;
	if (ui.video.dataset.src === filename) {
		return
	}
	ui.video.src = filename
	ui.video.dataset.src = filename
	const videoname = filename.substring(2)
	if (classification[filename] === undefined) {
		classification[filename] = {}
	}
	ui.attributes.innerHTML = ""
	const current = classification[filename]
	for (const attr of attributes[videoname].split(" ")) {
		const checked = [1, 2, 3].map(i => current[`${attr}_${i}`])
		const checkbox = createCheckbox(attr, checked)
		ui.attributes.appendChild(checkbox)
	}
}

// callback: download was requested
function downloadClick(ev) {
	const data = JSON.stringify(classification)
	ui.download.href = `data:application/json,${data}`
}

// callback: any checkbox button was clicked
function inputChange(ev) {
	const filename = ui.select.value
	const current = classification[filename]
	for (input of ui.attributes.querySelectorAll("input")) {
		current[input.name] = input.checked
	}
}

function keyDown(ev) {
	if (keyMap.has(ev.key)) {
		ev.preventDefault()
		keyMap.get(ev.key)()
	}
}

function prevClick(ev) {
	ui.select.selectedIndex = Math.max(0, ui.select.selectedIndex - 1)
	changeImage()
}

function nextClick(ev) {
	ui.select.selectedIndex = Math.min(ui.select.length - 1, ui.select.selectedIndex + 1)
	changeImage()
}

function setKeyMap() {
	const keys = [
		['ArrowLeft', prevClick],
		['ArrowRight', nextClick],
	]
	for (const [key, fn, ...args] of keys) {
		keyMap.set(key, fn.bind(null, ...args))
	}
}

window.onload = () => {
	ui.select = qel("select")
	ui.video = qel("video")
	ui.download = gel("download")
	ui.form = qel("form")
	ui.attributes = qel("table")
	for (const desc of images) {
		const [filename, ...attributes] = desc.split(" ")
		const num = filename.substring(0, 1)
		const videoname = filename.substring(2)
		ui.select.appendChild(cel("option", {textContent: `${num} - ${translation[videoname]}`, value: filename}))
	}
	ui.select.oninput = changeImage
	ui.download.onclick = downloadClick
	setKeyMap()
	document.onkeydown = keyDown
	gel("prev").onclick = prevClick
	gel("next").onclick = nextClick
	changeImage()
	ui.video.focus()
}

</script>
<style>
body {
	display: flex;
	flex-flow: column;
	align-items: center;
}
.hflex {
	display: flex;
	flex-flow: row;
	align-items: center;
}
.vflex>* {
	display: block;
}
video {
	margin: 1em 0;
}
</style>
</head>
<body>
<h1>Klasifikace logopedických cviků</h1>
<label>Zobrazený cvik:
<button id="prev">〈</button>
<select>
</select>
<button id="next">〉</button>
</label>

<form action="javascript:void(0);">
<div class=hflex>
	<video tabindex=0 controls loop></video>

	<table></table>
	</form>
</div>
<a id="download" download="logopedie.json">
<button>Uložit všechny záznamy...</button>
</a>
</body>
</html>
