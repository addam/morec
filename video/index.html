<!DOCTYPE html>
<html lang="cs">
<head>
	<title>Klasifikace logopedických cviků</title>
	<meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<script>
var subjects = [1, 2, 3, 4, 5]
const videos = {
	"jazyk_doleva_a_doprava.mp4": ["Střídání pohybu jazyka vpravo a vlevo", "tongue_left tongue_right tongue_shape lips_move two_symm jaw head neck", "Špičku jazyka střídavě vysouváme vpravo a vlevo směrem k uším. Ústa jsou otevřená, nepohybujeme dolní čelistí do stran"],
	"jazyk_nahoru_a_dolu.mp4": ["Střídání pohybu jazyka nahoru a dolů", "tongue_up tongue_down tongue_shape lips_move chin symm head neck jaw", "Špičku jazyka střídavě vysouváme nahoru a dolů. Jazyk držíme po krátkou dobu v napětí v obou pozicích. Ústa jsou otevřená, nepomáháme si dolní čelistí."],
	"krivy_usmev.mp4": ["Zvedání levého a pravého koutku", "corner corner_still two_symm head neck", "Zvedáme střídavě levý a pravý koutek nahoru do strany. Nepohybujeme čelistí."],
	"nafukovani_obou_tvari.mp4": ["Nafukování tváří", "brightness lips_open symm head", "Nafoukneme obě tváře a zadržíme v nich vzduch. Rty jsou pevně sevřené, vzduch nesmí unikat nosem ani ústy. Vzduch poté vydechneme."],
	"nafukovani_tvari.mp4": ["Střídavé nafukování tváří", "brightness lips_open two_symm head", "Nafoukneme obě tváře a zadržíme v nich vzduch. Rty jsou pevně sevřené. Vzduch poté pomalu přeléváme z jedné tváře do druhé. Vzduch nesmí unikat nosem ani ústy. Vzduch poté vydechneme."], // ?? jaw
	"obraceny_usmev.mp4": ["Koutky dolů", "-corner -open symm jaw head neck", "Stáhneme pravý i levý koutek současně směrem dolů."], // ?? jaw
	"ocko.mp4": ["Našpulení rtů se zuby (óčko ze rtů)", "square open -teeth tongue_still symm head", "Sevřeme a našpulíme rty směrem dopředu, rty jsou kulatě otevřené. Lehce skousnuté zuby jsou viditelné."],
	"pusinka.mp4": ["Našpulení rtů (pusinka)", "square lips_open symm head", "Sevřeme a našpulíme rty směrem dopředu."], // ?? neck
	"usmev.mp4": ["Úsměv", "corner -open width symm head", "Zavřeme ústa a roztáhneme rty do úsměvu. Snažíme se rozšířit úsměv co nejvíce do stran."],
	"usmev_zuby_od_sebe.mp4": ["Úsměv se zuby od sebe", "corner open width teeth symm head", "Doširoka se usmějeme. Otevřeme ústa a ukážeme horní i dolní zuby. Zuby nejsou skousnuté, snažíme se rozšířit úsměv co nejvíce do stran a uvolníme krk."],
	"usmev_zuby_u_sebe.mp4": ["Úsměv se zuby u sebe", "corner open width -teeth symm head", "Usmějeme se tak, aby šly vidět horní i dolní zuby. Snažíme se rozšířit úsměv co nejvíce do stran, zuby držíme u sebe."], // ?? neck
	"prologue-1": ["Hodnocení logopedických cviků", "", "Děkujeme, že věnujete svůj čas vyplnění tohoto dotazníku. Svými odbornými znalostmi pomůžete nám, vědcům v oblasti počítačů, vytvořit  logopedickou pomůcku v podobě počítačové aplikace. // Zabere to asi 20 minut. V průběhu je možné dotazník přerušit, zavřít okno prohlížeče a později se k vyplňování vrátit. // Budete hodnotit provedení různých logopedických cviků od celkem tří lidí. Na každém videu se navíc cvik třikrát opakuje a je nutné ohodnotit každé opakování zvlášť."],
	"prologue-2.mp4": ["Ukázka: správně provedený cvik Uzavřený úsměv", "corner -open width symm head", "V každém sloupci je potřeba zaškrtnout aspoň jednu hodnotu. // Pokud je cvik provedený úplně správně, zaškrtneme jen “Správně”. V případě, že jsou správně všechna tři opakování, stačí kliknout na samotné slovo “Správně” a vyplní se celý řádek. // Na další ukázku přejdeme tlačítkem “Další video” anebo stiskem šipky doprava."],
	"prologue-3.mp4": ["Ukázka: špatně provedený cvik Uzavřený úsměv", "corner -open width symm head", "Pokud cvik není provedený zcela správně, musíme označit všechny chyby, a to pro každé opakování. I zde je možné automaticky vyplnit celý řádek kliknutím na text. // Ve všech případech se můžete vyjádřit přesněji ve slovním komentáři."],
	"epilogue": ["Závěr", "", "Kliknutím na tlačítko zkontrolujete, že je vše vyplněné. // Poté se vaše záznamy automaticky odešlou, abychom je mohli zpracovat. Pokud chcete, můžete si záznam i stáhnout."],
}
const slides = ["prologue-1", "prologue-2.mp4", "prologue-3.mp4", "content", "epilogue"]
const columns = [0, 1, 2]
const translation = {
	"okay": "Správně",
	"corner": "Koutek úst nejde dost vysoko",
	"-corner": "Koutek úst nejde dost dolů",
	"corner_still": "Zapojuje se druhý koutek",
	"open": "Ústa jsou málo otevřená",
	"-open": "Ústa jsou otevřená",
	"width": "Úsměv je málo široký",
	"teeth": "Zuby zůstávají skousnuté",
	"square": "Rty netvoří kruh",
	"tongue_up": "Jazyk jde málo nahoru",
	"tongue_down": "Jazyk jde málo dolů",
	"tongue_left": "Jazyk jde málo doleva (z pohledu kamery)",
	"tongue_right": "Jazyk jde málo doprava (z pohledu kamery)",
	"brightness": "Tvář není dostatečně vyboulená",
	"symm": "Není symetrické",
	"two_symm": "Není symetrické na jednu a druhou stranu",
	"head": "Hýbe se hlava",
	"neck": "Zapojují se krční svaly",
	"lips_open": "Rty nejsou v kontaktu",
	"jaw": "Zapojuje se čelist",
	"tongue_shape": "Jazyk není v protažení",
	"lips_move": "Zapojují se rty",
	"-teeth": "Zuby nejsou v lehkém kontaktu",
	"tongue_still": "Není správná klidová poloha jazyka",
	"chin": "Zapojuje se bradový sval",
}
const ui = {}
const keyMap = new Map()

qel = (query) => document.querySelector(query)
gel = (id) => document.getElementById(id)

// create element
function cel(name, parameters={}) {
	var element = document.createElement(name)
	for (const param in parameters) {
		element[param] = parameters[param]
	}
	return element
}

// shuffle an array in-place and also return it
function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]]
    }
    return array
}

function splitAttributes(attributes) {
	return ("okay " + attributes).split(" ")
}

// callback: image was changed, update view
function changeImage() {
	const filename = ui.select.value;
	ui.progressbar.style.width = `${Math.round(100 * (ui.select.selectedIndex + 1) / ui.select.options.length)}%`
	if (ui.video.dataset.src === filename) {
		return
	}
	ui.video.dataset.src = filename
	const videoname = (filename[1] === "_") ? filename.substring(2) : filename
	const [title, attributes, description] = videos[videoname]
	ui.title.textContent = title
	for (const p of ui.header.querySelectorAll("p")) {
		p.remove()
	}
	for (const textContent of description.split(" // ")) {
		ui.header.appendChild(cel("p", {textContent}))
	}
	if (filename === "prologue-1") {
		document.body.dataset.slide = "prologue"
	} else if (filename === "epilogue") {
		document.body.dataset.slide = "epilogue"
		return
	} else {
		document.body.dataset.slide = "content"
		ui.video.src = filename
	}
	const classification = JSON.parse(localStorage.classification)
	if (classification[filename] === undefined) {
		classification[filename] = {}
		localStorage.classification = JSON.stringify(classification)
	}
	ui.attributes.innerHTML = ""
	const current = classification[filename]
	for (const attr of splitAttributes(attributes)) {
		const tr = cel("tr")
		for (const i of columns) {
			const td = cel("td")
			const name = `${attr}_${i}`
			td.append(cel("input", {type: "checkbox", onchange: inputChange, name, checked: current[name]}))
			tr.append(td)
		}
		tr.append(cel("td", {textContent: translation[attr], onclick: checkTr, classList: ["clickable"]}))
		ui.attributes.appendChild(tr)
		ui.comment.value = current[ui.comment.name] || ""
	}
	
}

// callback: validation was requested
async function validationClick(ev) {
	if (isComplete()) {
		const data = localStorage.classification
		ui.download.href = `data:application/json,${encodeURI(data)}`
		ui.download.classList.remove("hidden")
		try {
			var formData = new FormData();
			formData.append("expires", "2021-12-31")
			formData.append("maxDownloads", "1")
			formData.append("autoDelete", "true")
			const file = new File([data], "logopedie.json", {type : "application/json"})
			formData.append("file", file)
			const response = await fetch("https://file.io/", {
			  method: "POST",
			  headers: {
					"Accept": "application/json",
					"Authorization": "Basic SlJYMzNEQi5LNFY0VjRGLVIzQU1HS0YtSEM4QUtENy1TRzI5RVk2Og==",
				},
			  body: formData
			});
			if (response.status !== 200) {
				throw response
			}
			delete localStorage.classification
			window.alert("Díky, vaše hodnocení jsme dostali a bezpečně uložili.\nOkno prohlížeče můžete zavřít.")
		} catch (e) {
			window.alert("Ajaj, naše stránka udělala chybu!\nSoubor se nepodařilo automaticky uložit.\nProsím, stáhněte si zde vyplněný formulář a pošlete nám ho v příloze e-mailu.")
			ui.download.click()
		}
	} else {
		window.alert("Bohužel ještě není formulář zcela vyplněný. V každém sloupci by mělo být aspoň jedno políčko zaškrtnuté.")
		changeImage()
	}
}

// callback: any checkbox button was clicked
function inputChange(ev) {
	const filename = ui.select.value
	const classification = JSON.parse(localStorage.classification)
	const current = classification[filename]
	for (input of ui.attributes.querySelectorAll("input")) {
		current[input.name] = input.checked
	}
	current[ui.comment.name] = ui.comment.value
	localStorage.classification = JSON.stringify(classification)
}

// callback: mark all boxes in a <tr> as checked
function checkTr(ev) {
	const tr = ev.target.parentElement
	const inputs = Array.from(tr.querySelectorAll("input"))
	const value = !inputs.every(it => it.checked)
	for (const input of inputs) {
		input.checked = value
	}
	inputChange()
}

function keyDown(ev) {
	if (!(ev.ctrlKey || ev.shiftKey || ev.altKey || ev.metaKey) && keyMap.has(ev.key)) {
		ev.preventDefault()
		keyMap.get(ev.key)()
	}
}

function prevClick(ev) {
	ui.select.selectedIndex = Math.max(0, ui.select.selectedIndex - 1)
	changeImage()
}

function nextClick(ev) {
	ui.select.selectedIndex = Math.min(ui.select.length - 1, ui.select.selectedIndex + 1)
	changeImage()
}

// check that each video has some user input in each column
function isComplete() {
	const classification = JSON.parse(localStorage.classification)
	for (const option of ui.select.querySelectorAll("option")) {
		const filename = option.value
		if (slides.includes(filename)) {
			continue
		}
		const current = classification[filename] || {}
		const videoname = filename.substring(2)
		const everyColumnChecked = columns
			.every(i => splitAttributes(videos[videoname][1])
				.some(key => current[`${key}_${i}`]))
		const hasComment = (current["comment"] && current["comment"].trim() != "")
		if (!everyColumnChecked && !hasComment) {
			ui.select.value = filename
			return false
		}
	}
	return true
}

function setKeyMap() {
	const keys = [
		['ArrowLeft', prevClick],
		['ArrowRight', nextClick],
	]
	for (const [key, fn, ...args] of keys) {
		keyMap.set(key, fn.bind(null, ...args))
	}
}

window.onload = () => {
	try {
		var classification = JSON.parse(localStorage.classification)
	} catch (e) {
		classification = {}
	}
	if (typeof classification !== "object") {
		classification = {}
	}
  classification["prologue-2.mp4"] = { "okay_0": true, "okay_1": true, "okay_2": true }
  classification["prologue-3.mp4"] = {
		"-open_0": true, "width_0": true, "corner_0": true, "symm_0": true, "head_0": true, 
		"okay_1": true, "head_1": true, "okay_2": true,
    "comment": "Na začátku to bylo hrozné, ale od druhého opakování ten pohyb hlavy už skoro odstranil."
  }
	localStorage.classification = JSON.stringify(classification)
	if (window.location.search) {
		subjects = subjects.filter(i => window.location.search.includes(i))
	}

	ui.content = gel("content")
	ui.epilogue = gel("epilogue")
	ui.select = qel("select")
	ui.video = qel("video")
	ui.validation = gel("validation")
	ui.download = gel("download")
	ui.form = qel("form")
	ui.attributes = qel("tbody")
	ui.title = qel("h1")
	ui.header = qel("header")
	ui.comment = qel("textarea")
	ui.progressbar = qel(".progressbar")
	for (const slide of slides) {
		if (slide === "content") {
			for (const videoname of shuffle(Object.keys(videos).filter(name => !slides.includes(name)))) {
				for (const i of shuffle([...subjects])) {
					const filename = `${i}_${videoname}`
					ui.select.append(cel("option", {textContent: `${videos[videoname][0]} - ${i}`, value: filename}))
				}
			}
		} else {
			ui.select.append(cel("option", {textContent: videos[slide][0], value: slide}))
		}
	}

	ui.select.oninput = changeImage
	ui.validation.onclick = validationClick
	setKeyMap()
	document.onkeydown = keyDown
	gel("prev").onclick = prevClick
	gel("next").onclick = nextClick
	qel("#prologue button").onclick = nextClick
	changeImage()
	ui.video.focus()
}

</script>
<style>
* {
	font-family: Calibri, Segoe, sans-serif
}
body {
	display: flex;
	flex-flow: column;
	align-items: center;
	max-width: 1200px;
	margin: auto;
}
body>* {
	margin: 0.5em 0;
}
.hflex {
	display: flex;
	flex-flow: row wrap;
	justify-content: center;
	width: 100%
}
.vflex {
	max-width: 100vw;
	display: flex;
	flex-flow: column;
	justify-content: space-between;
}
.max-height * {
	height: 100px;
}
header p {
	font-size: 135%;
}
header, #prologue {
	text-align: center;
}
#prologue button {
	margin-bottom: 3em;
	font-size: 135%;
}
video {
	margin: 0 1em;
	max-width: 100vw;
}
table {
	border-collapse: collapse;
	width: 100%;
}
th:only-child {
	text-align: left;
}
tr:nth-child(1) td {
    border-bottom: 1px solid gray;
}
.clickable {
	cursor: pointer
}
body:not([data-slide=prologue]) #prologue,
body:not([data-slide=content]) #content,
body:not([data-slide=epilogue]) #epilogue,
.hidden {
	display: none
}
.progress-box {
	width: calc(100% - 2em);
	height: 1em;
	border: 1px solid gray;
}
.progressbar {
	width: attr(data-progress %);
	height: 100%;
	background-color: gray;
}
</style>
</head>
<body data-carousel=prologue>
<header>
<h1>Jazyk doleva a doprava</h1>
<p>Špičku jazyku střídavě vysouváme vpravo a vlevo směrem k uším. Ústa jsou otevřená, nepohybujeme dolní čelistí do stran.</p>
</header>
<div id=prologue>
	<button>Začínáme 〉</button>
	<div class="hflex max-height">
		<a href="https://assislt.utia.cas.cz"><img src="http://assislt.utia.cas.cz/images/phocadownload/assislt_32.png"></a>
		<a href="https://zoi.utia.cas.cz"><img src="http://www.utia.cas.cz/files/ZoiLogo.png"></a>
		<a href="https://www.utia.cas.cz"><img src="http://staff.utia.cas.cz/kolafova/web-obrazky/logoUTIA.png"></a>
		<a href="https://www.tacr.cz/program/program-zeta/"><img src="http://assislt.utia.cas.cz/images/tacr.png"></a>
	</div>
</div>
<div class=hflex id=content>
	<video tabindex=0 controls></video>

	<div class=vflex>
		<button id="prev" class=top>〈 Předchozí video</button>
		<div>
		<table><thead>
			<tr><th colspan=4>Opakování cviku</th></tr>
			<tr><th>1.</th><th>2.</th><th>3.</th><th></th></tr>
		</thead><tbody></tbody></table>
		<label class=vflex>Slovní komentář:
		<textarea name="comment" cols=30 rows=3 oninput="inputChange(event)"></textarea>
		</label>
		</div>
		<button id="next" class=bottom>Další video 〉</button>
	</div>
</div>
<div class=vflex id=epilogue>
	<button id=validation>Zkontrolovat formulář...</button>
	<a id="download" download="logopedie.json" class=hidden>Váš vyplněný formulář ke stažení</a>
</div>
<select></select>
<div class=progress-box><div class=progressbar></div></div>
<footer><a href="https://assislt.utia.cas.cz">Assislt</a> 2021 <a href="mailto:zitova@utia.cas.cz">zitova@utia.cas.cz</a></footer>
</body>
</html>
